# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  batch: true
  branches:
    include:
    - master
    - feature/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  disable.coverage.autogenerate: 'true'

steps:
  - task: UseDotNet@2
    displayName: "Install .Net Core 2 for SonarQube"
    inputs:
      packageType: 'runtime'
      version: '2.0.0'
  - task: UseDotNet@2
    displayName: "Install .Net Core 3.x"
    inputs:
      packageType: 'sdk'
      version: '3.x'
  - task: SonarCloudPrepare@1
    inputs:
      SonarCloud: 'SonarCloud'
      organization: 'fgi'
      scannerMode: 'MSBuild'
      projectKey: 'ComplianceReporting'
      projectName: 'ComplianceReporting'
      extraProperties: |
        sonar.exclusions=**/obj/**,**/*.dll
        sonar.branch.name=$(Build.SourceBranchName)
        sonar.msbuild.testProjectPattern=.*test\.csproj$
        sonar.cs.opencover.reportsPaths=$(Build.SourcesDirectory)/coverage/coverage.opencover.xml

  - script: dotnet build AzureDevOps.ReportingTool.sln --configuration "Debug"
    displayName: 'dotnet build Debug'

  - script: |
      dotnet test --logger trx --no-build /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=$(Build.SourcesDirectory)/coverage/ /p:exclude=\"[Microsoft*]*,[xunit*]*\" test/**/*.Unittest
    displayName: 'dotnet test'

  - script: |
      dotnet tool install dotnet-reportgenerator-globaltool --tool-path . 
      ./reportgenerator "-reports:$(Build.SourcesDirectory)/coverage/coverage.opencover.xml" "-targetdir:coverage/Cobertura" "-reporttypes:Cobertura;HTMLInline;HTMLChart"
    condition: eq( variables['Agent.OS'], 'Linux' )
    displayName: Run Reportgenerator on Linux

  - task: SonarCloudAnalyze@1

  - task: SonarCloudPublish@1
    displayName: 'Publish Quality Gate Results'

  - task: PublishTestResults@2
    inputs:
      testRunner: VSTest
      testResultsFiles: '**/*.trx'

  - task: PublishCodeCoverageResults@1
    inputs:
      summaryFileLocation: $(Build.SourcesDirectory)/coverage/Cobertura/Cobertura.xml
      reportDirectory: $(Build.SourcesDirectory)/coverage/Cobertura
      codecoverageTool: cobertura

  - task: DotNetCoreCLI@2
    inputs:
      command: publish
      arguments: '--configuration Debug --output $(Build.ArtifactStagingDirectory)'
      projects: '**/*.sln'
      publishWebProjects: false
      modifyOutputPath: true
      zipAfterPublish: true
  
  - task: PublishBuildArtifacts@1